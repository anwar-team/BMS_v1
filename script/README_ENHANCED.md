# Shamela Enhanced Scraper - سكربت الشاملة المحسن

سكربت محسن وذكي لاستخراج الكتب من المكتبة الشاملة (shamela.ws) مع التوافق الكامل مع مشروع BMS_v1 Laravel.

## 🚀 الميزات الجديدة

### ⚡ الأداء المحسن
- **طلبات متوازية**: استخراج عدة صفحات في نفس الوقت
- **سرعة محسنة**: تقليل التأخير بين الطلبات إلى 0.2 ثانية
- **معالجة ذكية للأخطاء**: إعادة المحاولة التلقائية مع تأخير متدرج
- **استخدام aiohttp**: مكتبة async محسنة للطلبات

### 📚 فهم كامل للهيكل
- **الأجزاء والمجلدات**: اكتشاف تلقائي للأجزاء ونطاقات الصفحات
- **الفهرس الهرمي**: استخراج الفصول والأبواب بشكل هرمي
- **ربط ذكي**: ربط الصفحات بالفصول والأجزاء المناسبة

### 🎯 استخراج البطاقة الكاملة
- **بطاقة الكتاب**: استخراج كامل لبطاقة الكتاب وحفظها في `description`
- **ترقيم المطبوع**: اكتشاف تلقائي لـ "ترقيم الكتاب موافق للمطبوع"
- **معلومات مهيكلة**: استخراج المؤلف والناشر والطبعة بشكل منفصل

### 🗄️ توافق كامل مع Laravel
- **نماذج متوافقة**: جميع النماذج متوافقة مع migrations Laravel
- **علاقات ذكية**: ربط المؤلفين والناشرين تلقائياً
- **منع التكرار**: فحص وجود المؤلفين والناشرين قبل الإنشاء

## 📋 المتطلبات

```bash
pip install -r requirements_enhanced.txt
```

### المكتبات المطلوبة:
- `aiohttp>=3.8.0` - للطلبات المتوازية
- `beautifulsoup4>=4.11.0` - لتحليل HTML
- `mysql-connector-python>=8.0.0` - للاتصال بقاعدة البيانات
- `lxml>=4.9.0` - محلل HTML سريع

## 🛠️ طرق الاستخدام

### 1. التشغيل التفاعلي (الأسهل)

```bash
python run_enhanced_scraper.py
```

سيظهر لك قائمة تفاعلية مع الخيارات التالية:
- اختبار الاتصال بقاعدة البيانات
- اختبار سريع (كتاب واحد بدون حفظ)
- استخراج كتاب واحد وحفظه
- استخراج عدة كتب

### 2. استخدام مباشر من Python

```python
import asyncio
from shamela_scraper_enhanced import scrape_book, scrape_multiple_books

# استخراج كتاب واحد
async def extract_single():
    book = await scrape_book("30151", save_to_db=True)
    print(f"تم استخراج: {book.title}")

# استخراج عدة كتب
async def extract_multiple():
    book_ids = ["30151", "12345", "67890"]
    books = await scrape_multiple_books(book_ids, save_to_db=True)
    print(f"تم استخراج {len(books)} كتاب")

# تشغيل
asyncio.run(extract_single())
```

### 3. سطر الأوامر

```bash
# استخراج كتاب واحد
python shamela_scraper_enhanced.py 30151

# استخراج عدة كتب
python shamela_scraper_enhanced.py 30151 12345 67890

# بدون حفظ في قاعدة البيانات
python shamela_scraper_enhanced.py 30151 --no-db

# حفظ في ملف JSON
python shamela_scraper_enhanced.py 30151 --output-json book.json

# تخصيص عدد الطلبات المتوازية
python shamela_scraper_enhanced.py 30151 --concurrent 10
```

## ⚙️ الإعدادات

### إعدادات قاعدة البيانات
يمكنك تعديل إعدادات قاعدة البيانات في ملف `shamela_scraper_enhanced.py`:

```python
DB_CONFIG = {
    'host': 'srv1800.hstgr.io',
    'port': 3306,
    'user': 'u994369532_test',
    'password': 'Test20205',
    'database': 'u994369532_test',
    'charset': 'utf8mb4',
    'autocommit': False,
    'raise_on_warnings': True
}
```

### إعدادات الأداء
```python
REQUEST_TIMEOUT = 15                    # مهلة الطلب بالثواني
MAX_CONCURRENT_REQUESTS = 5             # عدد الطلبات المتوازية
REQUEST_DELAY = 0.2                     # تأخير بين الطلبات
MAX_RETRIES = 3                         # عدد المحاولات عند الفشل
RETRY_DELAY = 2                         # تأخير بين المحاولات
```

## 📊 هيكل البيانات

### جدول الكتب (books)
```sql
- id: معرف فريد
- title: عنوان الكتاب
- description: بطاقة الكتاب كاملة
- slug: رابط صديق للمحركات
- pages_count: عدد الصفحات
- volumes_count: عدد الأجزاء
- source_url: رابط المصدر
- publisher_id: معرف الناشر
- edition: رقم الطبعة
- edition_DATA: بيانات الطبعة
```

### جدول المؤلفين (authors)
```sql
- id: معرف فريد
- full_name: الاسم الكامل
- biography: السيرة الذاتية
- madhhab: المذهب
- birth_year: سنة الميلاد
- death_year: سنة الوفاة
```

### جدول الأجزاء (volumes)
```sql
- id: معرف فريد
- book_id: معرف الكتاب
- number: رقم الجزء
- title: عنوان الجزء
- page_start: صفحة البداية
- page_end: صفحة النهاية
```

### جدول الفصول (chapters)
```sql
- id: معرف فريد
- book_id: معرف الكتاب
- volume_id: معرف الجزء
- title: عنوان الفصل
- parent_id: معرف الفصل الأب
- page_start: صفحة البداية
- page_end: صفحة النهاية
```

### جدول الصفحات (pages)
```sql
- id: معرف فريد
- book_id: معرف الكتاب
- volume_id: معرف الجزء
- chapter_id: معرف الفصل
- page_number: رقم الصفحة
- content: محتوى الصفحة
```

## 🔍 مثال على بطاقة الكتاب

عند استخراج كتاب، سيتم حفظ بطاقة الكتاب كاملة في عمود `description`:

```
الكتاب: بيت القصيد في شرح كتاب التوحيد
المؤلف: أحمد بن عبد الرحمن بن عثمان القاضي
الناشر: دار ابن الجوزي للنشر والتوزيع، الرياض - السعودية
الطبعة: الأولى، ١٤٤٣ هـ
عدد الأجزاء: ٢ (متسلسلة الترقيم)
[ترقيم الكتاب موافق للمطبوع]
صفحة المؤلف: [أحمد القاضي]
```

## 🚨 معالجة الأخطاء

السكربت يتعامل مع الأخطاء التالية:
- **أخطاء الشبكة**: إعادة المحاولة التلقائية
- **صفحات غير موجودة**: تخطي وتسجيل الخطأ
- **أخطاء قاعدة البيانات**: rollback تلقائي
- **انقطاع الاتصال**: إعادة الاتصال التلقائي

## 📈 مقارنة الأداء

| الميزة | السكربت القديم | السكربت المحسن |
|--------|----------------|-----------------|
| السرعة | بطيء (1 ثانية/طلب) | سريع (0.2 ثانية/طلب) |
| الطلبات المتوازية | لا | نعم (5 طلبات) |
| فهم الأجزاء | محدود | كامل |
| استخراج البطاقة | جزئي | كامل |
| معالجة الأخطاء | أساسية | متقدمة |
| التوافق مع Laravel | جزئي | كامل |

## 🔧 استكشاف الأخطاء

### خطأ في الاتصال بقاعدة البيانات
```bash
# تحقق من إعدادات قاعدة البيانات
python run_enhanced_scraper.py
# اختر الخيار 1: اختبار الاتصال
```

### بطء في الاستخراج
```bash
# زيادة عدد الطلبات المتوازية
python shamela_scraper_enhanced.py 30151 --concurrent 10
```

### أخطاء في الصفحات
- السكربت يتخطى الصفحات التي تحتوي على أخطاء تلقائياً
- يتم تسجيل جميع الأخطاء في ملف `shamela_enhanced_scraper.log`

## 📝 السجلات

يتم حفظ جميع العمليات في ملف `shamela_enhanced_scraper.log`:
- معلومات التقدم
- الأخطاء والتحذيرات
- إحصائيات الاستخراج
- أوقات العمليات

## 🤝 المساهمة

لتحسين السكربت:
1. اقترح تحسينات في الأداء
2. أضف دعم لمواقع أخرى
3. حسن معالجة الأخطاء
4. أضف اختبارات تلقائية

## 📄 الترخيص

هذا السكربت مطور خصيصاً لمشروع BMS_v1 ويمكن استخدامه وتعديله حسب الحاجة.

---

**ملاحظة**: يرجى استخدام السكربت بمسؤولية واحترام خوادم المكتبة الشاملة. السكربت مصمم ليكون سريعاً ولكن محترماً للخادم.