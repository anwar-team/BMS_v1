# تحليل شامل لصيغة .bok المستخدمة في المكتبة الشاملة

## نظرة عامة

صيغة `.bok` هي الصيغة المستخدمة في المكتبة الشاملة (Shamela) لتخزين الكتب الإسلامية والعربية. هذه الصيغة تحتوي على النصوص والبيانات الوصفية للكتب بطريقة منظمة ومفهرسة.

## الهيكل التقني للصيغة

### 1. طبيعة الملف
- **نوع الملف**: Microsoft Access Database (.mdb) مُعاد تسميته إلى .bok
- **محرك قاعدة البيانات**: Microsoft Jet Database Engine
- **الإصدار**: Jet DB 4.0 (Standard Jet DB)
- **الترميز**: يدعم Unicode للنصوص العربية

### 2. البنية الداخلية

من خلال فحص الملفات المرفقة، تم اكتشاف البنية التالية:

```
Standard Jet DB Header
├── Database Metadata
├── System Tables
│   ├── MSysObjects (كائنات قاعدة البيانات)
│   ├── MSysACEs (صلاحيات الوصول)
│   ├── MSysQueries (الاستعلامات)
│   └── MSysRelationships (العلاقات)
└── User Tables (جداول البيانات الفعلية)
    ├── Book Information (معلومات الكتاب)
    ├── Chapters/Sections (الفصول والأقسام)
    ├── Pages/Content (الصفحات والمحتوى)
    └── Indexes (الفهارس)
```

### 3. الجداول المتوقعة

بناءً على طبيعة المكتبة الشاملة، من المتوقع وجود الجداول التالية:

#### أ) جدول معلومات الكتاب (Book_Info)
- `BookID` - معرف الكتاب
- `Title` - عنوان الكتاب
- `Author` - المؤلف
- `Publisher` - الناشر
- `PublishYear` - سنة النشر
- `Category` - التصنيف
- `Description` - الوصف
- `TotalPages` - عدد الصفحات

#### ب) جدول المحتوى (Content)
- `ContentID` - معرف المحتوى
- `BookID` - معرف الكتاب (مفتاح خارجي)
- `PageNumber` - رقم الصفحة
- `ChapterTitle` - عنوان الفصل
- `Content` - النص الفعلي
- `FootNotes` - الحواشي

#### ج) جدول الفهرسة (Indexes)
- `IndexID` - معرف الفهرس
- `BookID` - معرف الكتاب
- `Keyword` - الكلمة المفتاحية
- `PageNumber` - رقم الصفحة
- `Position` - موقع الكلمة في الصفحة

#### د) جدول الأقسام (Sections)
- `SectionID` - معرف القسم
- `BookID` - معرف الكتاب
- `SectionTitle` - عنوان القسم
- `StartPage` - الصفحة الأولى
- `EndPage` - الصفحة الأخيرة
- `Level` - مستوى القسم (فصل، باب، مبحث)

## خصائص الصيغة

### المزايا
1. **ضغط البيانات**: استخدام قاعدة بيانات Access يوفر ضغطاً جيداً للنصوص
2. **الفهرسة**: إمكانية إنشاء فهارس متقدمة للبحث السريع
3. **العلاقات**: دعم العلاقات بين الجداول لتنظيم أفضل
4. **الاستعلامات**: إمكانية تخزين استعلامات معقدة
5. **دعم Unicode**: يدعم النصوص العربية بشكل كامل

### التحديات
1. **التوافق**: يتطلب Microsoft Access أو أدوات خاصة للقراءة
2. **النظام**: مصمم أساساً لنظام Windows
3. **الحجم**: قد تكون الملفات كبيرة الحجم
4. **الأمان**: قيود الأمان في قواعد بيانات Access

## أدوات القراءة والتحويل

### 1. أدوات سطر الأوامر
- **mdb-tools**: مجموعة أدوات Linux لقراءة ملفات .mdb
  ```bash
  mdb-tables file.bok          # عرض أسماء الجداول
  mdb-export file.bok table    # تصدير جدول إلى CSV
  mdb-schema file.bok          # عرض هيكل قاعدة البيانات
  ```

### 2. مكتبات PHP
- **mdb-tools/mdb-parser**: مكتبة Composer لقراءة ملفات .mdb
- **tangervu/phpaccess**: مكتبة أخرى لقراءة قواعد بيانات Access

### 3. أدوات التحويل الموجودة
- **shamela.org**: موقع لتحويل .bok إلى PDF/EPUB/MOBI
- **Elkirtasse**: تطبيق مفتوح المصدر لقراءة ملفات المكتبة الشاملة

## استراتيجية التحويل المقترحة

### المرحلة الأولى: التحليل والاستخراج
1. **تحديد الجداول**: استخدام mdb-tools لاستخراج أسماء الجداول
2. **فهم الهيكل**: تحليل العلاقات بين الجداول
3. **استخراج البيانات**: تصدير كل جدول إلى CSV أو JSON

### المرحلة الثانية: التحويل والتطبيع
1. **تنظيف البيانات**: إزالة البيانات غير المرغوبة
2. **تطبيع الهيكل**: تحويل البيانات لتتوافق مع نموذج BMS
3. **معالجة النصوص**: تنظيف النصوص العربية وتنسيقها

### المرحلة الثالثة: الإدراج في قاعدة البيانات
1. **إنشاء الكتاب**: إدراج معلومات الكتاب الأساسية
2. **إنشاء الأجزاء**: تقسيم الكتاب إلى أجزاء (إن وجدت)
3. **إنشاء الفصول**: إدراج الفصول والأقسام
4. **إدراج الصفحات**: إدراج محتوى الصفحات

## التحديات المتوقعة

### 1. تحديات تقنية
- **تنوع الهياكل**: قد تختلف هياكل الجداول بين الكتب
- **ترميز النصوص**: مشاكل في ترميز النصوص العربية
- **حجم البيانات**: بعض الكتب قد تحتوي على كمية كبيرة من البيانات

### 2. تحديات المحتوى
- **تنسيق النصوص**: الحاجة لمعالجة التنسيق والحواشي
- **الفهرسة**: إعادة بناء الفهارس والمراجع
- **التصنيف**: تحديد التصنيف المناسب للكتب

### 3. تحديات الأداء
- **سرعة التحويل**: ضمان سرعة معقولة للتحويل
- **استهلاك الذاكرة**: إدارة الذاكرة عند معالجة ملفات كبيرة
- **التزامن**: دعم تحويل عدة ملفات في نفس الوقت

## الحلول المقترحة

### 1. أداة التحويل المقترحة

```php
class BokConverter {
    private $mdbParser;
    private $bookService;
    
    public function convert($bokFilePath) {
        // 1. تحليل الملف
        $structure = $this->analyzeBokFile($bokFilePath);
        
        // 2. استخراج البيانات
        $bookData = $this->extractBookData($structure);
        
        // 3. تحويل البيانات
        $normalizedData = $this->normalizeData($bookData);
        
        // 4. إدراج في قاعدة البيانات
        return $this->insertIntoDatabase($normalizedData);
    }
}
```

### 2. واجهة المستخدم
- **رفع الملفات**: واجهة لرفع ملفات .bok
- **معاينة البيانات**: عرض معلومات الكتاب قبل التحويل
- **تتبع التقدم**: شريط تقدم لعملية التحويل
- **إدارة الأخطاء**: عرض الأخطاء والتحذيرات

### 3. التحسينات
- **التحويل المتوازي**: معالجة عدة ملفات في نفس الوقت
- **التخزين المؤقت**: حفظ البيانات المستخرجة مؤقتاً
- **الاستئناف**: إمكانية استئناف التحويل المتوقف
- **التحقق**: التحقق من سلامة البيانات المحولة

## خطة التنفيذ

### الأسبوع الأول: البحث والتحليل
- تحليل عينات إضافية من ملفات .bok
- تحديد الهيكل الموحد للبيانات
- اختبار أدوات mdb-tools

### الأسبوع الثاني: تطوير المحرك الأساسي
- تطوير فئة BokParser
- تطوير فئة DataNormalizer
- اختبار استخراج البيانات الأساسية

### الأسبوع الثالث: التكامل مع BMS
- تطوير BokImportService
- تكامل مع نماذج Laravel الموجودة
- اختبار إدراج البيانات

### الأسبوع الرابع: واجهة المستخدم والتحسينات
- تطوير واجهة Filament للاستيراد
- إضافة معالجة الأخطاء
- اختبار الأداء والتحسين

## الخلاصة

صيغة `.bok` هي في الأساس قاعدة بيانات Microsoft Access تحتوي على بيانات منظمة للكتب. باستخدام الأدوات المناسبة مثل mdb-tools ومكتبات PHP المتخصصة، يمكن استخراج هذه البيانات وتحويلها إلى نظام إدارة الكتب (BMS) بكفاءة عالية.

التحدي الرئيسي يكمن في فهم الهيكل الداخلي لكل كتاب وتطبيع البيانات لتتوافق مع نموذج BMS، بالإضافة إلى ضمان الحفاظ على جودة النصوص العربية وتنسيقها أثناء عملية التحويل.