برومبت: إصلاح المجلدات والصفحات المطبوعـة فقط
نطاق التنفيذ

عدّل السكربت الحالي بحيث:

يبني المجلدات من قائمة ج: في صفحة القراءة، ويحسب internal_start / internal_end بدقّة.

يفعّل الترقيم المطبوع إن وُجد الوسم في بطاقة الكتاب، ويقرأ رقم ص: لكل صفحة من <title> ويخزّنه كرقم الصفحة المعتمد.

ممنوع تغيير أي منطق آخر (العنوان، المؤلف، الناشر، الوصف، الفهرس… إلخ).

اختبر على كتاب المرجع ID=43 (بطاقته تذكر عدد الأجزاء: ٢٤، وصفحته تعرض في العنوان رقم الصفحة المطبوع بصيغة ص5 - ...). 
المكتبة الشاملة

القسم A — المجلدات (Volumes) من قائمة “ج:”
من أين؟

افتح صفحة قراءة واحدة: /book/{id}/1.

اقرأ قائمة “رقم الجزء (ج:)” الظاهرة في الـHTML (Dropdown فيه روابط 1..N). في كتاب 43 تظهر قائمة “ج:” بـ 1..24 ضمن الصفحة (DOM) من دون جافاسكربت. 
المكتبة الشاملة

ماذا نلتقط؟

لكل عنصر <a> في القائمة:

رقم الجزء من نص الرابط (يدعم الأرقام العربية-الهندية بتحويل Unicode U+0660..U+0669 إلى 0..9).

بداية الجزء داخلياً = N من href="/book/{id}/{N}#p1".

بعد الجمع:

أزِل التكرارات (خذ أصغر startN لنفس رقم الجزء).

رتّب تصاعديًا: [(1, N1), (2, N2), …].

حساب النهايات:
internal_end لكل جزء = بداية الجزء التالي − 1، وآخر جزء نهايته = أكبر N داخلي ظاهر في روابط الصفحة. (تظهر روابط كثيرة على الشكل /book/43/N داخل الصفحة). 
المكتبة الشاملة

مثال HTML (مصدر الحقيقة لبدايات الأجزاء)

استخدم القائمة التالية كنموذج تطبيقي لفكّ startN لكل جزء (كل #p1 تعني أول صفحة في ذلك الجزء):

<ul class="dropdown-menu" role="menu" style="max-height:305px; overflow:scroll">
  <li class="active"><a href="javascript:;">رقم الجزء</a></li>
  <li><a href="https://shamela.ws/book/43/1#p1" class="text-info">1</a></li>
  <li><a href="https://shamela.ws/book/43/599#p1">2</a></li>
  <li><a href="https://shamela.ws/book/43/1188#p1">3</a></li>
  ...
  <li><a href="https://shamela.ws/book/43/13939#p1">24</a></li>
</ul>

مخرجات الدالة

أعد قائمة كائنات/قواميس بالمفاتيح:

number, internal_start, internal_end

(اختياري) printed_start, printed_end (انظر أدناه).

معايير القبول (Volumes)

عدد المجلدات المستخرجة يساوي عدد الأجزاء في البطاقة (43 ⇒ 24).

يغطي المجال الداخلي 1..maxInternalPage بدون فجوات أو تداخل.

تحقق عيّنة: افتح internal_start لجزءين عشوائيين وتأكد أن شريط “ج:” بالصفحة يعرض نفس رقم الجزء. 
المكتبة الشاملة

القسم B — الترقيم المطبوع (Printed pagination)
متى نفعّله؟

إذا وُجد في بطاقة الكتاب الوسم [ترقيم الكتاب موافق للمطبوع] ⇒ فعّل وضع المطبوع.

من أين نقرأ رقم ص؟

أثناء جلب كل صفحة /book/{id}/{N}:

اقرأ <title> واستخرج رقم ص بــ Regex مرن:

[صس]\\s*[:：]?\\s*([0-9\\u0660-\\u0669]+)

حوّل الأرقام العربية-الهندية (Unicode U+0660..U+0669) إلى أرقام غربية ثم int. 
ويكيبيديا
+1

إن نجح: page_number = printed، ودوّن دائمًا page_index_internal = N.

إن فشل نادرًا: page_number = N وعلّمها داخليًا printed_missing=true.

ملاحظة مرجعية: عنوان صفحة 43 يبدأ بـ ص5 - ... وهذا تأكيد أن <title> يحمل الرقم المطبوع. 
المكتبة الشاملة

أثره على الفصول

مهم جدًا: أرقام الفهرس/عناوين الفصول هي ترقيم تسلسلي داخلي (أو جزء من الاسم) — لا تُستخدم كترقيم صفحات مطبوعة.

نحسب page_start/page_end للفصول من N الداخلي، ثم نُحوِّلها إلى مطبوع باستعمال خريطة N → printed بعدما أصبح لدينا رقم ص لكل صفحة تم جلبها. (لا نقرأ أي رقم من نص عنوان الفصل نفسه).

(اختياري) حدود مطبوعة للمجلد

لأجل printed_start/printed_end: افتح صفحتين فقط لكل جزء (أول/آخر) واقرأ رقم ص من <title> لكلٍ منهما.

معايير القبول (Printed)

عند تفعيل وضع المطبوع: pages[i].page_number يساوي رقم ص من <title> لنفس الصفحة. 
المكتبة الشاملة

خريطة N→printed متسقة بدون قفزات غير منطقية.

لا تعديل على أي حقول أخرى خارج النطاق.

تعليمات دمج (Minimal)

أضِف/عدِّل دالتين فقط:

extract_volumes_from_dropdown(book_id)

تُرجع: [{number, internal_start, internal_end, (printed_start?), (printed_end?)}] بالاعتماد على قائمة ج: في DOM.

انتبه: الأرقام العربية-الهندية تحتاج تحويل Unicode قبل int. 
ويكيبيديا

extract_printed_page_number(soup_or_title)

تُرجع int|None من <title> عبر الـRegex أعلاه.

اربط الأولى في مرحلة بناء المجلدات فقط، والثانية داخل حلقة جلب الصفحات.

لا تغيّر أي شيء آخر (عنوان/مؤلف/ناشر/وصف/فهرس…).

ملاحظات تقنية قصيرة

استخدام CSS selectors عبر select() وقراءة نص نظيف عبر get_text(separator, strip=True) موثّق رسميًا في BeautifulSoup؛ التزم بهما عند الحاجة. 
crummy.com
tutorialspoint.com

اختبار قبول نهائي على 43

Volumes: 24 عنصر من القائمة (مطابق للبطاقة)، ونطاق داخلي كامل بلا فجوات/تداخل. 
المكتبة الشاملة

Printed: <title> يعطي أرقام ص صحيحة (مثال: ص5 - ...) وتُسجّل كـ page_number. 
المكتبة الشاملة

تذكير مهم: ترقيم الفهرس/الفصول = داخلي/تسلسلي فقط، لا يُستعمل كترقيم مطبوع إطلاقًا — المرجعية الوحيدة للصفحات المطبوعة هي <title> أثناء القراءة.